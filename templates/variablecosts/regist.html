{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
{% if form.instance.pk %}
    <h2 class="my-3">購入品の編集</h2>
{% else %}
    <h2 class="my-3">購入品の新規登録</h2>
{% endif %}

<form method="post" class="needs-validation" novalidate enctype="multipart/form-data">
    {% csrf_token %}

    {% include "includes/bootstrap_field.html" with field=form.purchase_date %}
    
        <div class="mb-3">
            <label for="{{ form.amount.id_for_label }}" class="form-label">{{ form.amount.label }}</label>
            <div class="input-group">
                {% render_field form.amount class="form-control" %}
                <button type="button" class="btn btn-outline-secondary" onclick="openCalculator()">電卓</button>

                <!-- ★レシート読み取りボタン -->
                <button type="button" class="btn btn-outline-secondary" id="scan-receipt-btn">
                    レシート読み取り
                </button>
            </div>

            <!-- ★カメラ/画像用の隠し input -->
            <input
                type="file"
                id="receipt-input"
                accept="image/*"
                capture="environment"
                style="display: none;"
            >
        </div>


    {% include "includes/bootstrap_field.html" with field=form.cost_item %}
    {% include "includes/bootstrap_field.html" with field=form.description %}
    


    {% include "includes/bootstrap_field.html" with field=form.payer %}

    <button type="submit" class="btn btn-outline-primary">保存</button>
    {% if form.instance.pk %}
        <a href="{% url 'variablecosts:delete' form.instance.pk %}" class="btn btn-outline-danger">削除</a>
    {% endif %}
</form><br>

<a href="{% url 'variablecosts:list' %}" class="btn btn-outline-secondary mb-2">一覧に戻る</a><br>

{% include "includes/calculator_modal.html" %}

<script>
    (function () {
        const scanBtn = document.getElementById("scan-receipt-btn");
        const fileInput = document.getElementById("receipt-input");
        const amountInput = document.getElementById("id_amount");            // 金額
        const dateInput = document.getElementById("id_purchase_date");       // 購入日
        const costItemSelect = document.getElementById("id_cost_item");      // 費目
        const descriptionInput = document.getElementById("id_description");  // 名称
        const csrfTokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');

        if (!scanBtn || !fileInput || !amountInput || !csrfTokenInput) {
            return;
        }

        const csrfToken = csrfTokenInput.value;

        // ボタン押下でカメラ / 画像選択を開く
        scanBtn.addEventListener("click", function () {
            fileInput.click();
        });

        // 画像選択後にAPIへ送信
        fileInput.addEventListener("change", function () {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("receipt_image", file);

            scanBtn.disabled = true;
            const originalText = scanBtn.textContent;
            scanBtn.textContent = "読み取り中...";

            fetch("{% url 'variablecosts:scan_receipt' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": csrfToken,
                },
                body: formData,
            })
            .then(async (response) => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || "レシートの読み取りに失敗しました。");
                }
                return data;
            })
            .then((data) => {
                // 金額
                if (data.amount !== undefined && data.amount !== null) {
                    amountInput.value = data.amount;
                }
                // 購入日 (YYYY-MM-DD)
                if (data.purchase_date && dateInput) {
                    dateInput.value = data.purchase_date;
                }
                // 名称
                if (data.description && descriptionInput) {
                    descriptionInput.value = data.description;
                }
                // 費目 (select の value に id を入れる)
                if (data.cost_item_id && costItemSelect) {
                    costItemSelect.value = data.cost_item_id;
                }

                alert("レシートの読み取りが完了しました。");
            })
            .catch((err) => {
                console.error(err);
                alert(err.message || "レシートの読み取り中にエラーが発生しました。");
            })
            .finally(() => {
                scanBtn.disabled = false;
                scanBtn.textContent = originalText;
                fileInput.value = ""; // 同じ画像を選び直せるようにクリア
            });
        });
    })();
</script>



{% endblock %}
