{% extends 'base.html' %}
{% load humanize %}
{% block content %}

<h2 class="mb-4">固定費一覧（{{ year }}年{{ month }}月）</h2>

<!-- 月移動バー -->
<div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
  <div>
    {% if prev_exists %}
      <a href="{% url 'fixedcosts:list_by_month' prev_year prev_month %}" class="btn btn-outline-secondary">&lt;&lt; 前月</a>
    {% else %}
      <a href="{% url 'fixedcosts:edit_by_month' prev_year prev_month %}" class="btn btn-outline-secondary">&lt;&lt; 前月のデータを作成</a>
    {% endif %}
  </div>

  <select class="form-select w-auto" onchange="if(this.value){ window.location.href=this.value; }" aria-label="月を選択">
    {% for m in available_months %}
      <option value="{% url 'fixedcosts:list_by_month' m.year m.month %}" {% if m.year == year and m.month == month %}selected{% endif %}>
        {{ m.year }}年{{ m.month }}月
      </option>
    {% endfor %}
  </select>

  <div>
    {% if next_month %}
      {% if next_exists %}
        <a href="{% url 'fixedcosts:list_by_month' next_year next_month %}" class="btn btn-outline-secondary">翌月 &gt;&gt;</a>
      {% else %}
        <a href="{% url 'fixedcosts:edit_by_month' next_year next_month %}" class="btn btn-outline-secondary">翌月のデータを作成 &gt;&gt;</a>
      {% endif %}
    {% else %}
      <button class="btn btn-outline-secondary" disabled>翌月 &gt;&gt;</button>
    {% endif %}
  </div>
</div>

<!-- 操作ボタン -->
<div class="mb-3">
  {% if fixed_cost %}
    <a href="{% url 'fixedcosts:edit_by_month' year month %}" class="btn btn-outline-primary me-2">編集</a>
    <a href="{% url 'fixedcosts:delete' year month %}" class="btn btn-outline-danger">削除</a>
  {% else %}
    <a href="{% url 'fixedcosts:edit_by_month' year month %}" class="btn btn-outline-primary">この月のデータを登録</a>
  {% endif %}
</div>

{% if fixed_cost %}
  <!-- 合計 -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">
      <h5 class="card-title">今月の固定費合計</h5>
      <p class="card-text fs-4 fw-bold text-primary">{{ total_cost|intcomma }} 円</p>
    </div>
  </div>

  <!-- 円グラフ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">家賃以外の内訳</h5>
        {% if cost_item_totals %}
        <div class="chart-wrapper" style="position: relative; height: 300px;">
            <canvas id="costPieChart"></canvas>
        </div>
        {% else %}
        <p class="text-muted">今月の固定費データはまだありません。</p>
        {% endif %}
    </div>
  </div>

  <!-- モバイル表示 -->
  <div class="d-block d-md-none">
    {% for label, value, note in items %}
      <div class="card mb-3 shadow-sm">
        <div class="card-header bg-light">
          <h6 class="mb-0">{{ label }}{% if label == "水道代" %} (割り勘済み){% endif %}</h6>
        </div>
        <div class="card-body">
          <p class="card-text">
            {% if value is not None %}
              {{ value|intcomma }} 円
            {% elif value == 0 %}
              未入力
            {% else %}
              未登録
            {% endif %}
          </p>
        </div>
      </div>
    {% endfor %}
  </div>

  <!-- PC表示 -->
  <div class="table-responsive d-none d-md-block">
    <table class="table table-striped table-bordered">
      <thead class="table-light">
        <tr>
          <th>項目</th>
          <th class="text-end">金額</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>家賃</td><td class="text-end">{{ fixed_cost.rent|default:"-"|intcomma }} 円</td></tr>
        <tr>
          <td>水道代{% if fixed_cost.water is not None  %} (割り勘計算){% elif adjusted_water > 0 %} (前月から流用){% endif %}</td>
          <td class="text-end">{{ adjusted_water|default:"-"|intcomma }} 円</td>
        </tr>
        <tr><td>電気代</td><td class="text-end">{{ fixed_cost.electricity|default:"-"|intcomma }} 円</td></tr>
        <tr><td>ガス代</td><td class="text-end">{{ fixed_cost.gas|default:"-"|intcomma }} 円</td></tr>
        <tr><td>ネット代</td><td class="text-end">{{ fixed_cost.internet|default:"-"|intcomma }} 円</td></tr>
        <tr><td>サブスク</td><td class="text-end">{{ fixed_cost.subscriptions|default:"-"|intcomma }} 円</td></tr>
        <tr class="table-secondary">
          <td class="fw-bold">合計</td>
          <td class="text-end fw-bold">{{ total_cost|intcomma }} 円</td>
        </tr>
      </tbody>
    </table>
  </div>
{% else %}
  <div class="alert alert-info">
    {{ year }}年{{ month }}月のデータはまだ登録されていません。「この月のデータを登録」ボタンから入力してください。
  </div>
{% endif %}

<script>
    {% if cost_item_totals %}
    const ctx = document.getElementById('costPieChart').getContext('2d');

    const labels = [
        {% for item in cost_item_totals %}
            "{{ item.cost_item__name }}",
        {% endfor %}
    ];

    const data = [
        {% for item in cost_item_totals %}
            {{ item.total }},
        {% endfor %}
    ];

    const backgroundColors = [
        '#D93F3C', // ガス
        '#C49200', // 電気
        '#59A14F', // ネット
        '#4E79A7', // 水道
        '#9C6ACF', // サブスク
        '#5A5A5A', // その他
    ];

    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '40%',
            plugins: {
                legend: {
                    position: 'bottom',
                },
                datalabels: {
                    color: '#fff',
                    font: {
                        weight: 'bold',
                        size: 12
                    },
                    anchor: 'end',
                    align: 'start',
                    offset: 10,
                    formatter: (value, context) => {
                        const label = context.chart.data.labels[context.dataIndex];
                        return label + "\n" + value.toLocaleString() + " 円";
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            return label + "\n" + value.toLocaleString() + " 円";
                        }
                    }
                }
            }
        },
        plugins: [
            ChartDataLabels,
            {
                id: 'centerText',
                beforeDraw: function(chart) {
                    const ctx = chart.ctx;
                    const width = chart.width;
                    const height = chart.height;
                    const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                    ctx.restore();
                    
                    // 基本フォントサイズ
                    const baseFontSize = Math.min(width, height) / 16;
                    ctx.textBaseline = 'middle';
                    
                    // 中央の座標を計算
                    const centerX = width / 2;
                    const centerY = height / 2;
                    
                    // 「家賃以外」ラベル（中央より明確に上側に配置）
                    ctx.font = `${baseFontSize * 0.7}px Arial`;
                    ctx.fillStyle = '#666';
                    const labelText = '総額';
                    const labelWidth = ctx.measureText(labelText).width;
                    ctx.fillText(labelText, centerX - labelWidth / 2, centerY - baseFontSize * 2.0);
                    
                    // 合計金額（中央より少し上側に配置）
                    ctx.font = `bold ${baseFontSize * 0.9}px Arial`;
                    ctx.fillStyle = '#333';
                    const totalText = total.toLocaleString() + '円';
                    const totalWidth = ctx.measureText(totalText).width;
                    ctx.fillText(totalText, centerX - totalWidth / 2, centerY - baseFontSize * 0.8);
                    
                    ctx.save();
                }
            }
        ]
    });
    {% endif %}
</script>
{% endblock %}
