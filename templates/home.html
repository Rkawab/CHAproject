{% extends "base.html" %}
{% load humanize %}

{% block content %}
<h2 class="mb-4">å®¶è¨ˆç°¿ã‚¢ãƒ—ãƒªã¸ã‚ˆã†ã“ã</h2>

<a href="{% url 'variablecosts:regist' %}" class="btn btn-outline-primary mb-2">è³¼å…¥å“æ–°è¦è¿½åŠ </a>

<!-- åˆè¨ˆé‡‘é¡ã®è¡¨ç¤º -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        <h5 class="card-title mb-0">ä»Šæœˆã®å‡ºè²»åˆè¨ˆ</h5>

        <!-- ä½¿ç”¨é‡‘é¡ã¨æ®‹é¡ï¼ˆæ¨ªä¸¦ã³ï¼‰ -->
        <p class="card-text fs-4 fw-bold text-primary d-flex align-items-center">
            {{ total_amount|intcomma }} å††
            <span class="badge ms-3 {% if remaining_total < 0 %}bg-danger{% else %}bg-primary{% endif %}">
                æ®‹é¡ {{ remaining_total|intcomma }} å††
            </span>
        </p>
        {% if total_fixed_cost %}
            <ul class="list-group">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <strong class="me-2">å›ºå®šè²»</strong>
                    <div>
                        <span class="badge bg-secondary me-1">ä½¿ç”¨ {{ total_fixed_cost|intcomma }} å††</span>
                        <span class="badge {% if remaining_fixed < 0 %}bg-danger{% else %}bg-primary{% endif %} me-1">
                            æ®‹é¡ {{ remaining_fixed|intcomma }} å††
                        </span>
                    </div>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <strong class="me-2">å¤‰å‹•è²»</strong>
                    <div>
                        <span class="badge bg-secondary me-1">ä½¿ç”¨ {{ total_variable_cost|intcomma }} å††</span>
                        <span class="badge {% if remaining_variable < 0 %}bg-danger{% else %}bg-primary{% endif %} me-1">
                            æ®‹é¡ {{ remaining_variable|intcomma }} å††
                        </span>
                    </div>
                </li>
            </ul>
        {% else %}
        <p class="text-muted">ä»Šæœˆã®å‡ºè²»ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
        {% if missing_fixed_items %}
            <div class="alert alert-warning d-flex justify-content-between align-items-center flex-wrap">
            <div class="mb-2 mb-md-0">
                <strong>æœªå…¥åŠ›ã®å›ºå®šè²»ï¼š</strong>
                <a href="{% url 'fixedcosts:edit_by_month' year month %}" class="btn btn-sm btn-outline-primary">ä»Šæœˆã®å›ºå®šè²»ã‚’ç·¨é›†</a><br>
                {% for item in missing_fixed_items %}
                <span class="badge bg-info text-write me-1">{{ item }}</span>
                {% endfor %}
            </div>

            </div>
        {% endif %}
    </div>
</div>

<!-- è²»ç›®ã”ã¨ã®åˆè¨ˆè¡¨ç¤º -->
<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <h5 class="card-title mb-3">å¤‰å‹•è²»ã®å†…è¨³</h5>
        {% if cost_item_totals %}
            <div class="chart-wrapper chart-wrapper--pie">
                <canvas id="costPieChart"></canvas>
            </div>
        {% else %}
        <p class="text-muted">ä»Šæœˆã®å‡ºè²»ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
</div>


<!-- ç«‹æ›¿è€…ã”ã¨ã®åˆè¨ˆã¨ç«‹æ›¿å®Œäº†ãƒœã‚¿ãƒ³ -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <h5 class="card-title mb-3">ç«‹æ›¿é‡‘é¡(ç²¾ç®—ã¯å…±ç”¨å£åº§ã‹ã‚‰)</h5>
        {% if payer_totals %}
        <ul class="list-group">
            {% for payer in payer_totals %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <span class="d-inline-block" style="min-width: 80px;">{{ payer.payer__name }} ã«</span>
                <span class="badge bg-warning text-dark rounded-pill">{{ payer.total|intcomma }} å††</span>
                <form method="POST" action="{% url 'variablecosts:clear_payer' payer.payer__name %}" onsubmit="return confirm('{{ payer.payer__name }} ã•ã‚“ã¸ç²¾ç®—ã‚’å®Ÿæ–½ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">å…¥é‡‘å®Ÿæ–½</button>
                </form>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-muted">ç«‹æ›¿ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        {% endif %}
    </div>
</div>

<script>
    {% if cost_item_totals %}
        const ctx = document.getElementById('costPieChart').getContext('2d');

        // ãƒ©ãƒ™ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
        const labels = [
        {% for item in cost_item_totals %}
            "{{ item.cost_item__name }}",
        {% endfor %}
        ];

        const data = [
        {% for item in cost_item_totals %}
            {{ item.total }},
        {% endfor %}
        ];

        const backgroundColors = [
            '#D93F3C', // ğŸ”´ èµ¤ç³»ï¼ˆæ˜ã‚‹ã™ããšæš—ã™ããšï¼‰
            '#C49200', // ğŸŸ¡ æ¿ƒã„é»„é‡‘è‰²ï¼ˆç™½æ–‡å­—ã‚‚è¦‹ã‚„ã™ã„ï¼‰
            '#59A14F', // ğŸŸ¢ ç·‘ç³»ï¼ˆä¸­ç¨‹åº¦ã®æ˜ã‚‹ã•ï¼‰
            '#4E79A7', // ğŸ”µ é’ç³»ï¼ˆæ¿ƒã„é’ï¼‰
            '#9C6ACF', // ğŸŸ£ ç´«ç³»ï¼ˆä¸­æ¿ƒåº¦ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼å¯„ã‚Šï¼‰
            '#5A5A5A', // âš« é»’ç³»ï¼ˆãƒ€ãƒ¼ã‚¯ã‚°ãƒ¬ãƒ¼ï¼‰
        ];

        new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
            data: data,
            backgroundColor: backgroundColors,
            borderColor: '#fff',
            borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
            legend: {
                position: 'bottom',
            },
            datalabels: {
                color: '#fff',
                font: {
                weight: 'bold',
                size: 12
                },
                anchor: 'end',   // ä¸­å¿ƒã‹ã‚‰é›¢ã™
                align: 'start',  // å¤–å‘¨ã«å‘ã‘ã¦æƒãˆã‚‹
                offset: 10,      // ãƒ©ãƒ™ãƒ«ã‚’å††ã‹ã‚‰å°‘ã—å¤–ã¸
                formatter: (value, context) => {
                const label = context.chart.data.labels[context.dataIndex];
                return label + "\n" + value.toLocaleString() + " å††";
                }
            }
            }
        },
        plugins: [ChartDataLabels]
        });
    {% endif %}
</script>

{% endblock content %}
