<!-- 電卓モーダル -->
<div class="modal" tabindex="-1" id="calculatorModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">電卓</h5>
        <button type="button" class="btn-close" onclick="closeCalculator()"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="calcDisplay" class="form-control mb-2" readonly>
        <div class="d-grid gap-1">
            <div class="btn-group" role="group">
                <button class="btn btn-secondary" onclick="appendCalc('7')">7</button>
                <button class="btn btn-secondary" onclick="appendCalc('8')">8</button>
                <button class="btn btn-secondary" onclick="appendCalc('9')">9</button>
                <button class="btn btn-warning" onclick="appendCalc('/')">÷</button>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-secondary" onclick="appendCalc('4')">4</button>
                <button class="btn btn-secondary" onclick="appendCalc('5')">5</button>
                <button class="btn btn-secondary" onclick="appendCalc('6')">6</button>
                <button class="btn btn-warning" onclick="appendCalc('*')">×</button>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-secondary" onclick="appendCalc('1')">1</button>
                <button class="btn btn-secondary" onclick="appendCalc('2')">2</button>
                <button class="btn btn-secondary" onclick="appendCalc('3')">3</button>
                <button class="btn btn-warning" onclick="appendCalc('-')">−</button>
            </div>
            <div class="btn-group" role="group">
                <button class="btn btn-secondary" onclick="appendCalc('0')">0</button>
                <button class="btn btn-danger" onclick="clearCalc()">C</button>
                <button class="btn btn-success" onclick="calculate()">=</button>
                <button class="btn btn-warning" onclick="appendCalc('+')">＋</button>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let calcExpression = '';
let currentTargetId = null;

function openCalculator(targetId = null) {
    calcExpression = '';
    document.getElementById('calcDisplay').value = '';
    
    // ターゲットIDを保存（変動費の場合はamount、固定費の場合は具体的なフィールドID）
    if (targetId) {
        currentTargetId = targetId;
    } else {
        // 変動費の場合、デフォルトでamountフィールドを探す
        const amountField = document.querySelector('input[name="amount"]');
        if (amountField) {
            currentTargetId = amountField.id;
        }
    }
    
    new bootstrap.Modal(document.getElementById('calculatorModal')).show();
}

function closeCalculator() {
    bootstrap.Modal.getInstance(document.getElementById('calculatorModal')).hide();
    currentTargetId = null;
}

function appendCalc(val) {
    calcExpression += val;
    document.getElementById('calcDisplay').value = calcExpression;
}

function clearCalc() {
    calcExpression = '';
    document.getElementById('calcDisplay').value = '';
}

function calculate() {
    try {
        const result = eval(calcExpression);
        
        // 現在のターゲットフィールドに結果を設定
        if (currentTargetId) {
            const targetField = document.getElementById(currentTargetId);
            if (targetField) {
                targetField.value = Math.floor(result);
            } else {
                // IDで見つからない場合は、name属性で探してみる
                const fieldByName = document.querySelector(`input[name="${currentTargetId}"]`);
                if (fieldByName) {
                    fieldByName.value = Math.floor(result);
                } else {
                    alert('対象のフィールドが見つかりません');
                    return;
                }
            }
        } else {
            // フォールバック: 変動費のamountフィールドを探す
            const amountField = document.querySelector('input[name="amount"]');
            if (amountField) {
                amountField.value = Math.floor(result);
            } else {
                alert('対象のフィールドが見つかりません');
                return;
            }
        }
        
        closeCalculator();
    } catch (e) {
        alert('計算式が正しくありません');
    }
}
</script>